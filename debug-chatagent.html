<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug ChatAgent</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #047857; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <h1>üîç ChatAgent Debug Console</h1>
    
    <div class="debug-panel">
        <h2>Library Status</h2>
        <div id="library-status" class="status info">Checking...</div>
    </div>

    <div class="debug-panel">
        <h2>ChatAgent Test</h2>
        <button onclick="testCornerWidget()">Test Corner Widget</button>
        <button onclick="testInlineWidget()">Test Inline Widget</button>
        <button onclick="testAPIConnection()">Test API Connection</button>
        <button onclick="testMarkdownRendering()">Test Markdown</button>
        <button onclick="inspectWidget()">Inspect Widget</button>
        <button onclick="clearAll()">Clear All</button>
        <div id="test-status" class="status info">Ready to test</div>
    </div>

    <div class="debug-panel">
        <h2>Console Output</h2>
        <pre id="console-output">Console output will appear here...</pre>
    </div>

    <!-- Inline widget container -->
    <div class="debug-panel">
        <h2>Inline Widget Container</h2>
        <div id="inline-container" style="height: 400px; border: 2px dashed #ccc; border-radius: 8px; position: relative;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">
                Inline widget will appear here
            </div>
        </div>
    </div>

    <script src="dist/index.js"></script>
    
    <script>
        let chatAgent = null;
        let consoleLog = [];

        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            consoleLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateConsoleDisplay();
            
            // Call original function
            if (type === 'log') originalLog(...args);
            else if (type === 'error') originalError(...args);
            else if (type === 'warn') originalWarn(...args);
        }

        console.log = (...args) => addToConsole('log', ...args);
        console.error = (...args) => addToConsole('error', ...args);
        console.warn = (...args) => addToConsole('warn', ...args);

        function updateConsoleDisplay() {
            const output = document.getElementById('console-output');
            output.textContent = consoleLog.slice(-20).join('\n'); // Show last 20 lines
            output.scrollTop = output.scrollHeight;
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function checkLibraryStatus() {
            console.log('üîç Checking library status...');
            
            if (typeof window.AgentmanChatWidget === 'undefined') {
                updateStatus('library-status', '‚ùå AgentmanChatWidget not loaded', 'error');
                return false;
            }

            console.log('‚úÖ AgentmanChatWidget found:', Object.keys(window.AgentmanChatWidget));

            if (!window.AgentmanChatWidget.ChatAgent) {
                updateStatus('library-status', '‚ùå ChatAgent class not found', 'error');
                return false;
            }

            updateStatus('library-status', '‚úÖ ChatAgent class available', 'success');
            return true;
        }

        function testCornerWidget() {
            console.log('üß™ Testing corner widget...');
            updateStatus('test-status', 'üß™ Testing corner widget...', 'info');

            try {
                // Clear any existing widget
                if (chatAgent) {
                    console.log('üóëÔ∏è Destroying existing widget');
                    chatAgent.destroy();
                    chatAgent = null;
                }

                const ChatAgent = window.AgentmanChatWidget.ChatAgent;
                
                const config = {
                    agentToken: 'test-token-123',
                    containerId: 'corner-container', // This won't be used for corner variant
                    variant: 'corner',
                    position: 'bottom-right',
                    title: 'Debug ChatAgent',
                    initiallyOpen: false,
                    theme: {
                        textColor: '#111827',
                        backgroundColor: '#ffffff',
                        buttonColor: '#2563eb',
                        buttonTextColor: '#ffffff',
                        agentForegroundColor: '#111827',
                        userForegroundColor: '#ffffff',
                        toggleBackgroundColor: '#059669',
                        toggleTextColor: '#ffffff',
                        toggleIconColor: '#ffffff'
                    }
                };

                console.log('üìã Creating ChatAgent with config:', config);
                chatAgent = new ChatAgent(config);
                
                console.log('‚úÖ ChatAgent created:', chatAgent);
                
                // Check if element was created
                const widget = document.querySelector('.am-chat-widget');
                if (widget) {
                    console.log('‚úÖ Widget element found in DOM:', widget);
                    updateStatus('test-status', '‚úÖ Corner widget created successfully', 'success');
                } else {
                    throw new Error('Widget element not found in DOM');
                }

            } catch (error) {
                console.error('‚ùå Corner widget test failed:', error);
                updateStatus('test-status', `‚ùå Corner widget failed: ${error.message}`, 'error');
            }
        }

        function testInlineWidget() {
            console.log('üß™ Testing inline widget...');
            updateStatus('test-status', 'üß™ Testing inline widget...', 'info');

            try {
                // Clear any existing widget
                if (chatAgent) {
                    console.log('üóëÔ∏è Destroying existing widget');
                    chatAgent.destroy();
                    chatAgent = null;
                }

                const ChatAgent = window.AgentmanChatWidget.ChatAgent;
                
                const config = {
                    agentToken: 'test-token-123',
                    containerId: 'inline-container',
                    variant: 'inline',
                    title: 'Debug ChatAgent (Inline)',
                    initiallyOpen: true,
                    theme: {
                        textColor: '#111827',
                        backgroundColor: '#ffffff',
                        buttonColor: '#2563eb',
                        buttonTextColor: '#ffffff',
                        agentForegroundColor: '#111827',
                        userForegroundColor: '#ffffff',
                        toggleBackgroundColor: '#059669',
                        toggleTextColor: '#ffffff',
                        toggleIconColor: '#ffffff'
                    }
                };

                console.log('üìã Creating inline ChatAgent with config:', config);
                chatAgent = new ChatAgent(config);
                
                console.log('‚úÖ Inline ChatAgent created:', chatAgent);
                updateStatus('test-status', '‚úÖ Inline widget created successfully', 'success');

            } catch (error) {
                console.error('‚ùå Inline widget test failed:', error);
                updateStatus('test-status', `‚ùå Inline widget failed: ${error.message}`, 'error');
            }
        }

        function inspectWidget() {
            if (!chatAgent) {
                updateStatus('test-status', '‚ùå No widget to inspect', 'error');
                return;
            }

            console.log('üîç Inspecting ChatAgent...');
            console.log('ChatAgent instance:', chatAgent);
            console.log('ChatAgent methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(chatAgent)).filter(prop => typeof chatAgent[prop] === 'function'));
            
            if (chatAgent.uiManager) {
                console.log('UIManager found:', chatAgent.uiManager);
                console.log('UIManager root element:', chatAgent.uiManager.getRootElement());
            }

            const widget = document.querySelector('.am-chat-widget');
            console.log('Widget DOM element:', widget);
            
            if (widget) {
                console.log('Widget classes:', widget.className);
                console.log('Widget style:', widget.style.cssText);
                console.log('Widget children:', Array.from(widget.children).map(el => el.className));
            }

            updateStatus('test-status', 'üîç Inspection complete - check console', 'info');
        }

        function testMarkdownRendering() {
            console.log('üìù Testing markdown rendering...');
            updateStatus('test-status', 'üìù Testing markdown rendering...', 'info');

            if (!chatAgent) {
                updateStatus('test-status', '‚ùå Create a widget first', 'error');
                return;
            }

            try {
                // Simulate adding a markdown message like the one from your API response
                const testMessage = {
                    id: 'test-md-' + Date.now(),
                    sender: 'ai',
                    content: `I specialize in analyzing various types of files, including images, PDFs, and text documents. Here's what I can do for you:

1. **Extract Content**: Perform OCR on images to extract text, and read the content of PDFs and text documents.
2. **Analyze and Summarize**: Provide a detailed analysis and summary of the key information from the files.
3. **Actionable Insights**: Offer insights based on the analysis to help you make informed decisions.
4. **Categorize Data**: Identify and categorize different types of data within the files.
5. **Security and Privacy**: Ensure secure handling of your files, with no storage beyond the analysis session.

If you have files ready for analysis, feel free to upload them now! You can also test:
- *Italic text*
- **Bold text**
- \`inline code\`
- [Link to example](https://example.com)
- :) :D <3 emojis

> This is a blockquote to test formatting.`,
                    timestamp: new Date().toISOString(),
                    type: 'text'
                };

                console.log('üß™ Adding test markdown message:', testMessage);
                chatAgent.addMessage(testMessage);

                // Check if the message was rendered with HTML
                setTimeout(() => {
                    const messages = document.querySelectorAll('.am-chat-message');
                    const lastMessage = messages[messages.length - 1];
                    
                    if (lastMessage) {
                        const messageContent = lastMessage.querySelector('.am-chat-message-content');
                        if (messageContent) {
                            console.log('üìù Rendered message HTML:', messageContent.innerHTML);
                            
                            // Check for various markdown elements
                            const hasLists = messageContent.innerHTML.includes('<ol>') || messageContent.innerHTML.includes('<ul>');
                            const hasBold = messageContent.innerHTML.includes('<strong>');
                            const hasItalic = messageContent.innerHTML.includes('<em>');
                            const hasLinks = messageContent.innerHTML.includes('<a href');
                            const hasBlockquote = messageContent.innerHTML.includes('<blockquote>');
                            
                            console.log('üîç Markdown rendering check:');
                            console.log('  - Lists:', hasLists ? '‚úÖ' : '‚ùå');
                            console.log('  - Bold:', hasBold ? '‚úÖ' : '‚ùå');
                            console.log('  - Italic:', hasItalic ? '‚úÖ' : '‚ùå');
                            console.log('  - Links:', hasLinks ? '‚úÖ' : '‚ùå');
                            console.log('  - Blockquotes:', hasBlockquote ? '‚úÖ' : '‚ùå');
                            
                            if (hasLists && hasBold && hasItalic) {
                                updateStatus('test-status', '‚úÖ Markdown rendering working!', 'success');
                            } else {
                                updateStatus('test-status', '‚ö†Ô∏è Some markdown features missing', 'error');
                            }
                        }
                    }
                }, 100);

            } catch (error) {
                console.error('‚ùå Markdown test failed:', error);
                updateStatus('test-status', `‚ùå Markdown test failed: ${error.message}`, 'error');
            }
        }

        function testAPIConnection() {
            console.log('üåê Testing API connection...');
            updateStatus('test-status', 'üåê Testing API connection...', 'info');

            const testConfig = {
                agentToken: '.eJyrVipJzUvMK4nPTFGyMtRRSiwoyMlMTizJzM-DC6WnQuXNjWoBmfsQRw.aGdvKA.gM2XYb7-SdnG2CmBqHaWoGDR4zM',
                apiUrl: 'http://localhost:8000'
            };

            fetch(`${testConfig.apiUrl}/v2/agentman_runtime/agent`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    agent_token: testConfig.agentToken,
                    force_load: false,
                    conversation_id: 'test-' + Date.now(),
                    user_input: 'Hello'
                })
            })
            .then(response => {
                console.log('üì° API Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ API Response data:', data);
                updateStatus('test-status', '‚úÖ API connection successful!', 'success');
            })
            .catch(error => {
                console.error('‚ùå API connection failed:', error);
                updateStatus('test-status', `‚ùå API failed: ${error.message}`, 'error');
            });
        }

        function clearAll() {
            if (chatAgent) {
                chatAgent.destroy();
                chatAgent = null;
            }
            
            // Clear inline container
            const inlineContainer = document.getElementById('inline-container');
            inlineContainer.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">Inline widget will appear here</div>';
            
            consoleLog = [];
            updateConsoleDisplay();
            updateStatus('test-status', 'üßπ All cleared', 'info');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ Debug page loaded');
            
            setTimeout(() => {
                const isReady = checkLibraryStatus();
                if (isReady) {
                    console.log('üöÄ Ready for testing!');
                    updateStatus('test-status', 'üöÄ Ready for testing - click a button above', 'success');
                }
            }, 100);
        });
    </script>
</body>
</html>