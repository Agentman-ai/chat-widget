<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Communication</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .config {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .config h2 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #0084ff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0073e6;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .widget-container {
            margin-top: 20px;
        }
        .log {
            background: #333;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: #888;
        }
        .log-success {
            color: #4caf50;
        }
        .log-error {
            color: #f44336;
        }
        .log-info {
            color: #2196f3;
        }
        .log-debug {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="config">
            <h2>ðŸ§ª Test API Communication</h2>
            <div class="form-group">
                <label for="apiUrl">API URL</label>
                <input type="text" id="apiUrl" value="https://api-staging.agentman.app/agents/chatcompletionstream" />
            </div>
            <div class="form-group">
                <label for="agentToken">Agent Token</label>
                <input type="text" id="agentToken" value="cjkqyuqoe0009jx081vgn38x7" />
            </div>
            <div class="buttons">
                <button onclick="createWidget()">Create Widget</button>
                <button onclick="testAPI()">Test API Directly</button>
                <button onclick="clearLog()">Clear Log</button>
            </div>
        </div>

        <div id="widget-container" class="widget-container"></div>

        <div class="config">
            <h3>ðŸ“‹ Console Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="./dist/index.js"></script>
    <script>
        let widget = null;
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            debug: console.debug,
            info: console.info
        };

        // Intercept console methods
        function interceptConsole() {
            ['log', 'error', 'warn', 'debug', 'info'].forEach(method => {
                console[method] = function(...args) {
                    logToPage(method, args);
                    originalConsole[method].apply(console, args);
                };
            });
        }

        function logToPage(level, args) {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString();
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');

            let levelClass = 'log-info';
            if (level === 'error') levelClass = 'log-error';
            else if (level === 'warn') levelClass = 'log-debug';
            else if (level === 'debug') levelClass = 'log-debug';
            else if (message.includes('âœ…') || message.includes('Success')) levelClass = 'log-success';

            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${levelClass}">[${level.toUpperCase()}]</span> ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            logToPage('info', ['Log cleared']);
        }

        interceptConsole();

        function createWidget() {
            const apiUrl = document.getElementById('apiUrl').value;
            const agentToken = document.getElementById('agentToken').value;

            if (!apiUrl || !agentToken) {
                console.error('Please provide both API URL and Agent Token');
                return;
            }

            // Destroy existing widget if any
            if (widget) {
                widget.destroy();
                widget = null;
            }

            // Clear container
            const container = document.getElementById('widget-container');
            container.innerHTML = '';

            console.log('Creating widget with config:', {
                apiUrl,
                agentToken,
                debug: true
            });

            try {
                // Try to use refactored version if available
                const WidgetClass = window.ChatWidgetRefactored || window.ChatWidget;
                console.log('Using widget class:', WidgetClass.name);

                widget = new WidgetClass({
                    containerId: 'widget-container',
                    apiUrl: apiUrl.replace(/\/+$/, ''), // Remove trailing slashes
                    agentToken: agentToken,
                    variant: 'inline',
                    debug: true,
                    welcomeMessage: 'Hello! How can I help you today?',
                    prompts: [
                        'What can you do?',
                        'Tell me about your features',
                        'How do I get started?'
                    ]
                });

                console.log('âœ… Widget created successfully');
            } catch (error) {
                console.error('Failed to create widget:', error);
            }
        }

        async function testAPI() {
            const apiUrl = document.getElementById('apiUrl').value;
            const agentToken = document.getElementById('agentToken').value;

            if (!apiUrl || !agentToken) {
                console.error('Please provide both API URL and Agent Token');
                return;
            }

            console.log('Testing API directly...');

            const requestBody = {
                agent_token: agentToken,
                force_load: false,
                conversation_id: `test_${Date.now()}`,
                user_input: 'Hello, this is a test message'
            };

            console.log('Request body:', requestBody);

            try {
                const fullUrl = `${apiUrl}/v2/agentman_runtime/agent`;
                console.log('Full URL:', fullUrl);
                
                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    console.log('âœ… API test successful');
                } else {
                    console.error('API returned error status');
                }
            } catch (error) {
                console.error('API test failed:', error);
            }
        }

        // Initial log message
        logToPage('info', ['Test page loaded. Click "Create Widget" to start testing.']);
    </script>
</body>
</html>