<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatWidget Unified Demo</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
        }
        #chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        #chat-container.inline-mode {
            position: relative;
            bottom: auto;
            right: auto;
            width: 100%;
            height: 600px;
            margin: 20px 0;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .config-panel {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .form-column {
            flex: 1;
            min-width: 300px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="checkbox"] {
            width: auto;
        }
        input[type="color"] {
            height: 40px;
            padding: 2px;
        }
        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 3px;
            vertical-align: middle;
            margin-left: 5px;
        }
        .actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #059669;
        }
        .section-title {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .storage-info {
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            max-height: 300px;
            overflow: auto;
            white-space: pre;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #f5f5f5;
            border-color: #ddd;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>ChatWidget Unified Demo</h1>
    
    <div class="tabs">
        <div class="tab active" data-tab="config">Configuration</div>
        <div class="tab" data-tab="persistence">Persistence</div>
        <div class="tab" data-tab="debug">Debug</div>
    </div>
    
    <!-- Configuration Tab -->
    <div class="tab-content active" id="config-tab">
        <div class="config-panel">
            <form id="configForm" onsubmit="return false;">
                <div class="form-row">
                    <!-- Basic Configuration -->

<!-- Message Prompts Configuration -->
<div class="form-column">
    <h2 class="section-title">Message Prompts</h2>
    <div class="form-group">
        <label>
            <input type="checkbox" id="promptsShow" checked>
            Show Welcome Message & Prompts
        </label>
    </div>
    <div class="form-group">
        <label for="welcomeMessage">Welcome Message</label>
        <input type="text" id="welcomeMessage" value="Welcome! How can I help you today?">
    </div>
    <div class="form-group">
        <label for="prompt1">Prompt 1</label>
        <input type="text" id="prompt1" value="What can you do?">
    </div>
    <div class="form-group">
        <label for="prompt2">Prompt 2</label>
        <input type="text" id="prompt2" value="Give me a tour.">
    </div>
    <div class="form-group">
        <label for="prompt3">Prompt 3</label>
        <input type="text" id="prompt3" value="Help me get started.">
    </div>
</div>

                    <div class="form-column">
                        <h2 class="section-title">Basic Settings</h2>
                        
                        <div class="form-group">
                            <label for="apiUrl">API URL</label>
                            <input type="text" id="apiUrl" value="http://localhost:8000">
                        </div>
                        
                        <div class="form-group">
                            <label for="agentToken">Agent Token</label>
                            <input type="text" id="agentToken" value=".eJyrVipJzUvMK4nPTFGyMtJRSiwoyMlMTizJzM-DC6WnQuUNDQ1qAao_EHI.aI1tQA.hTJc3JYGdTzSBl-hL5xJPts9ysI">
                        </div>
                        
                        <div class="form-group">
                            <label for="title">Widget Title</label>
                            <input type="text" id="title" value="Chat Assistant">
                        </div>
                        
                        <div class="form-group">
                            <label for="placeholder">Placeholder Text</label>
                            <input type="text" id="placeholder" value="Type your message..." />
                        </div>
                        
                        <div class="form-group">
                            <label for="initialMessage">Initial Message</label>
                            <input type="text" id="initialMessage" placeholder="Optional welcome message from the AI" />
                        </div>
                    </div>
                    
                    <!-- Message Prompts Configuration -->
                    <div class="form-column">
                        <h2 class="section-title">Message Prompts</h2>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="promptsShow" checked> Show Floating Prompts
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label for="welcomeMessage">Welcome Message</label>
                            <input type="text" id="welcomeMessage" value="How can I help you today?" />
                        </div>
                        
                        <div class="form-group">
                            <label for="prompt1">Prompt 1</label>
                            <input type="text" id="prompt1" value="What services do you offer?" />
                        </div>
                        
                        <div class="form-group">
                            <label for="prompt2">Prompt 2</label>
                            <input type="text" id="prompt2" value="Tell me about pricing" />
                        </div>
                        
                        <div class="form-group">
                            <label for="prompt3">Prompt 3</label>
                            <input type="text" id="prompt3" value="I need help with my account" />
                        </div>
                        
                        <h3 style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd;">AI Disclaimer</h3>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="disclaimerEnabled"> Show AI Disclaimer
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label for="disclaimerMessage">Disclaimer Message</label>
                            <input type="text" id="disclaimerMessage" value="AI can make mistakes. Please check responses." />
                        </div>
                        
                        <div class="form-group">
                            <label for="disclaimerLinkText">Link Text (optional)</label>
                            <input type="text" id="disclaimerLinkText" value="Learn more" />
                        </div>
                        
                        <div class="form-group">
                            <label for="disclaimerLinkUrl">Link URL (optional)</label>
                            <input type="text" id="disclaimerLinkUrl" value="https://example.com/ai-policy" />
                        </div>
                        
                        <h3 style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd;">Display Settings</h3>
                        
                        <div class="form-group">
                            <label for="variant">Widget Variant</label>
                            <select id="variant">
                                <option value="corner">Corner (Floating Button)</option>
                                <option value="centered">Centered (Modal)</option>
                                <option value="inline">Inline (Embedded in Page)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="position">Widget Position</label>
                            <select id="position">
                                <option value="bottom-right">Bottom Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="top-left">Top Left</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="initiallyOpen"> Initially Open
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="streamingEnabled" checked> Enable Streaming
                            </label>
                        </div>
                    </div>
                    
                    <!-- Theme Configuration -->
                    <div class="form-column">
                        <h2 class="section-title">Theme Settings</h2>
                        
                        <div class="form-group">
                            <label for="buttonColor">Button Color</label>
                            <input type="color" id="buttonColor" value="#2563eb">
                            <span class="color-preview" style="background-color: #10b981;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="headerTextColor">Header Text</label>
                            <input type="color" id="headerTextColor" value="#FFFFFF">
                            <span class="color-preview" style="background-color: #FFFFFF;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="backgroundColor">Widget Background</label>
                            <input type="color" id="backgroundColor" value="#FFFFFF">
                            <span class="color-preview" style="background-color: #FFFFFF;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="textColor">Text Color</label>
                            <input type="color" id="textColor" value="#111827">
                            <span class="color-preview" style="background-color: #111827;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="buttonColor">Button Color</label>
                            <input type="color" id="buttonColor" value="#10b981">
                            <span class="color-preview" style="background-color: #10b981;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="buttonTextColor">Button Text</label>
                            <input type="color" id="buttonTextColor" value="#FFFFFF">
                            <span class="color-preview" style="background-color: #FFFFFF;"></span>
                        </div>
                        
                        <h3 style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd;">Toggle Button</h3>
                        
                        <div class="form-group">
                            <label for="toggleText">Toggle Button Text</label>
                            <input type="text" id="toggleText" value="Ask Agentman">
                        </div>
                        
                        <div class="form-group">
                            <label for="toggleBackgroundColor">Toggle Background</label>
                            <input type="color" id="toggleBackgroundColor" value="#10b981">
                            <span class="color-preview" style="background-color: #10b981;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="toggleTextColor">Toggle Text</label>
                            <input type="color" id="toggleTextColor" value="#FFFFFF">
                            <span class="color-preview" style="background-color: #FFFFFF;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="toggleIconColor">Toggle Icon</label>
                            <input type="color" id="toggleIconColor" value="#000000">
                            <span class="color-preview" style="background-color: #000000;"></span>
                        </div>
                    </div>
                    
                    <!-- Message Styling -->
                    <div class="form-column">
                        <h2 class="section-title">Message Styling</h2>
                        
                        <div class="form-group">
                            <label for="userBackgroundColor">User Message Background</label>
                            <input type="color" id="userBackgroundColor" value="#10b981">
                            <span class="color-preview" style="background-color: #10b981;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="userForegroundColor">User Message Text</label>
                            <input type="color" id="userForegroundColor" value="#FFFFFF">
                            <span class="color-preview" style="background-color: #FFFFFF;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="agentBackgroundColor">Agent Message Background</label>
                            <input type="color" id="agentBackgroundColor" value="#f3f4f6">
                            <span class="color-preview" style="background-color: #f3f4f6;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="agentForegroundColor">Agent Message Text</label>
                            <input type="color" id="agentForegroundColor" value="#111827">
                            <span class="color-preview" style="background-color: #111827;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="userIconColor">User Icon Color</label>
                            <input type="color" id="userIconColor" value="#10b981">
                            <span class="color-preview" style="background-color: #10b981;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="agentIconColor">Agent Icon Color</label>
                            <input type="color" id="agentIconColor" value="#1e293b">
                            <span class="color-preview" style="background-color: #1e293b;"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Persistence Settings -->
                <div class="form-row">
                    <div class="form-column">
                        <h2 class="section-title">Persistence Settings</h2>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="persistenceEnabled" checked> Enable Persistence
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label for="persistenceDays">Days to Keep Messages</label>
                            <input type="number" id="persistenceDays" value="7" min="1" max="30">
                        </div>
                        
                        <div class="form-group">
                            <label for="persistenceKey">Custom Storage Key (optional)</label>
                            <input type="text" id="persistenceKey" placeholder="Leave blank for default">
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <div>
                        <button type="button" onclick="resetConfig()">Reset to Defaults</button>
                        <button type="button" onclick="applyConfig()">Apply Configuration</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Persistence Tab -->
    <div class="tab-content" id="persistence-tab">
        <div class="config-panel">
            <h2 class="section-title">Persistence Controls</h2>
            
            <div class="form-row">
                <div class="form-column">
                    <button onclick="reloadPage()">Reload Page</button>
                    <button onclick="clearStorage()">Clear Storage</button>
                    <button onclick="showStorage()">Show Storage</button>
                    <button onclick="showConversationId()">Show Conversation ID</button>
                </div>
            </div>
            
            <div class="storage-info" id="storageInfo"></div>
        </div>
    </div>
    
    <!-- Debug Tab -->
    <div class="tab-content" id="debug-tab">
        <div class="config-panel">
            <h2 class="section-title">Debug Configuration</h2>
            
            <div class="form-row">
                <div class="form-column">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="debugEnabled" onchange="updateDebugMode()"> Enable Debug Mode
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="debugLogLevel">Log Level</label>
                        <select id="debugLogLevel" onchange="updateDebugMode()">
                            <option value="error">Error</option>
                            <option value="warn">Warning</option>
                            <option value="info" selected>Info</option>
                            <option value="debug">Debug</option>
                            <option value="verbose">Verbose</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="debugTimestamps" checked onchange="updateDebugMode()"> Include Timestamps
                        </label>
                    </div>
                </div>
            </div>
            
            <h2 class="section-title">Debug Information</h2>
            
            <div class="form-row">
                <div class="form-column">
                    <button onclick="showWidgetState()">Show Widget State</button>
                    <button onclick="showWidgetMethods()">Show Widget Methods</button>
                    <button onclick="showPersistenceManager()">Show Persistence Manager</button>
                    <button onclick="testLogging()">Test Logging Levels</button>
                </div>
            </div>
            
            <div class="storage-info" id="debugInfo"></div>
        </div>
    </div>
    
    <div id="chat-container"></div>
    
    <!-- Include the bundled widget -->
    <script src="dist/index.js"></script>
    
    <script>
        let chatWidget;
        const STORAGE_KEY = 'chatwidget_chat-container_data';
        
        // Initialize the widget with persistence
        function initWidget() {
            // Get the ChatWidget class
            const ChatWidget = window.AgentmanChatWidget?.ChatWidget || window.AgentmanChatWidget;
            
            // console.log('Using built-in persistence functionality');
            
            // Debug the ChatWidget prototype (commented out for cleaner output)
            // console.log('ChatWidget prototype methods:', 
            //     Object.getOwnPropertyNames(ChatWidget.prototype).filter(prop => 
            //         typeof ChatWidget.prototype[prop] === 'function'
            //     )
            // );
            
            // Create widget instance with persistence enabled
            chatWidget = new ChatWidget(getFormConfig());
            
            // console.log('Widget initialized with persistence');
        }
        
        // UI Helper Functions
        function reloadPage() {
            window.location.reload();
        }
        
        function clearStorage() {
            if (chatWidget && chatWidget.persistenceManager) {
                chatWidget.persistenceManager.clearStorage();
                console.log('Storage cleared');
                showStorage();
            } else {
                console.error('ChatWidget not initialized or persistenceManager not available');
            }
        }
        
        function showStorage() {
            try {
                const storageInfo = document.getElementById('storageInfo');
                const containerPrefix = 'chatwidget_chat-container_';
                
                // Get all localStorage keys that start with the widget prefix
                const widgetKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(containerPrefix)) {
                        widgetKeys.push(key);
                    }
                }
                
                if (widgetKeys.length === 0) {
                    storageInfo.textContent = 'No storage data found for chat widget';
                    return;
                }
                
                // Sort keys to put index first, then sort by conversation ID
                widgetKeys.sort((a, b) => {
                    if (a.endsWith('_index')) return -1;
                    if (b.endsWith('_index')) return 1;
                    return a.localeCompare(b);
                });
                
                // Create formatted output for each key
                let outputText = '';
                
                widgetKeys.forEach(key => {
                    const raw = localStorage.getItem(key);
                    try {
                        const data = JSON.parse(raw);
                        const prettyData = JSON.stringify(data, null, 2);
                        
                        // Add a section header for each key
                        outputText += `\n=== ${key} ===\n${prettyData}\n\n`;
                        
                        // Add conversation title information if this is the index
                        if (key.endsWith('_index') && data.conversations) {
                            outputText += '--- Active Conversations ---\n';
                            data.conversations.forEach(conv => {
                                const isActive = data.currentId === conv.id ? '* ' : '  ';
                                outputText += `${isActive}${conv.id} - ${conv.title} (Updated: ${new Date(conv.lastUpdated).toLocaleString()})\n`;
                            });
                            outputText += '\n';
                        }
                    } catch (error) {
                        outputText += `\n=== ${key} ===\nError parsing JSON: ${error.message}\nRaw data: ${raw}\n\n`;
                    }
                });
                
                storageInfo.textContent = outputText;
            } catch (error) {
                console.error('Error reading storage:', error);
                document.getElementById('storageInfo').textContent = 'Error: ' + error.message;
            }
        }
        
        function showConversationId() {
            try {
                const storageInfo = document.getElementById('storageInfo');
                
                if (!chatWidget) {
                    storageInfo.textContent = 'ChatWidget not initialized';
                    return;
                }
                
                // Get conversation ID from widget
                const widgetConvId = chatWidget.conversationId;
                
                // Get conversation ID from storage
                let storageConvId = null;
                try {
                    const key = chatWidget?.persistenceManager?.getStorageKey() || STORAGE_KEY;
                    const raw = localStorage.getItem(key);
                    if (raw) {
                        const data = JSON.parse(raw);
                        storageConvId = data.conversationId;
                    }
                } catch (e) {
                    console.error('Error getting storage conversation ID:', e);
                }
                
                // Display information
                const info = {
                    widget_conversation_id: widgetConvId || 'Not available',
                    storage_conversation_id: storageConvId || 'Not available',
                    match: widgetConvId && storageConvId ? 
                        (widgetConvId === storageConvId ? 'YES ✅' : 'NO ❌') : 
                        'Cannot determine (missing IDs)',
                    storage_key: chatWidget?.persistenceManager?.getStorageKey() || STORAGE_KEY
                };
                
                storageInfo.textContent = JSON.stringify(info, null, 2);
            } catch (e) {
                console.error('Error showing conversation ID:', e);
            }
        }
        
        function showWidgetState() {
            try {
                const debugInfo = document.getElementById('debugInfo');
                
                if (!chatWidget) {
                    debugInfo.textContent = 'ChatWidget not initialized';
                    return;
                }
                
                const state = chatWidget.stateManager?.getState() || 'No state available';
                debugInfo.textContent = JSON.stringify(state, null, 2);
            } catch (e) {
                console.error('Error showing widget state:', e);
            }
        }
        
        function showWidgetMethods() {
            try {
                const debugInfo = document.getElementById('debugInfo');
                
                if (!chatWidget) {
                    debugInfo.textContent = 'ChatWidget not initialized';
                    return;
                }
                
                const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(chatWidget))
                    .filter(prop => typeof chatWidget[prop] === 'function');
                
                debugInfo.textContent = JSON.stringify(methods, null, 2);
            } catch (e) {
                console.error('Error showing widget methods:', e);
            }
        }
        
        function showPersistenceManager() {
            try {
                const debugInfo = document.getElementById('debugInfo');
                
                if (!chatWidget || !chatWidget.persistenceManager) {
                    debugInfo.textContent = 'Persistence Manager not available';
                    return;
                }
                
                const pmInfo = {
                    enabled: chatWidget.config.persistence?.enabled,
                    days: chatWidget.config.persistence?.days,
                    key: chatWidget.persistenceManager.getStorageKey(),
                    conversationId: chatWidget.conversationId
                };
                
                debugInfo.textContent = JSON.stringify(pmInfo, null, 2);
            } catch (e) {
                console.error('Error showing persistence manager:', e);
            }
        }
        
        function updateDebugMode() {
            if (!chatWidget || !chatWidget.logger) {
                console.log('Widget not initialized or logger not available');
                return;
            }
            
            const enabled = document.getElementById('debugEnabled').checked;
            const logLevel = document.getElementById('debugLogLevel').value;
            const timestamps = document.getElementById('debugTimestamps').checked;
            
            // Update logger configuration
            chatWidget.logger.setConfig({
                enabled: enabled,
                logLevel: logLevel,
                timestamps: timestamps,
                console: true
            });
            
            console.log(`Debug mode updated: enabled=${enabled}, level=${logLevel}, timestamps=${timestamps}`);
        }
        
        function testLogging() {
            if (!chatWidget || !chatWidget.logger) {
                console.log('Widget not initialized or logger not available');
                return;
            }
            
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent = 'Testing logging levels...\n\n';
            
            // Test each log level
            chatWidget.logger.error('This is an ERROR message');
            chatWidget.logger.warn('This is a WARNING message');
            chatWidget.logger.info('This is an INFO message');
            chatWidget.logger.debug('This is a DEBUG message');
            chatWidget.logger.verbose('This is a VERBOSE message');
            
            debugInfo.textContent += 'Check the browser console to see which messages appear based on the current log level.\n\n';
            debugInfo.textContent += `Current settings:\n`;
            debugInfo.textContent += `- Enabled: ${document.getElementById('debugEnabled').checked}\n`;
            debugInfo.textContent += `- Log Level: ${document.getElementById('debugLogLevel').value}\n`;
            debugInfo.textContent += `- Timestamps: ${document.getElementById('debugTimestamps').checked}\n`;
        }
        
        function getFormConfig() {
            // Read message prompts fields
            const promptsShow = document.getElementById('promptsShow')?.checked;
            const welcomeMessage = document.getElementById('welcomeMessage')?.value || '';
            const prompt1 = document.getElementById('prompt1')?.value || '';
            const prompt2 = document.getElementById('prompt2')?.value || '';
            const prompt3 = document.getElementById('prompt3')?.value || '';

            return {
                apiUrl: document.getElementById('apiUrl').value,
                agentToken: document.getElementById('agentToken').value,
                title: document.getElementById('title').value,
                placeholder: document.getElementById('placeholder').value,
                variant: document.getElementById('variant').value,
                position: document.getElementById('position').value,
                initiallyOpen: document.getElementById('initiallyOpen').checked,
                containerId: 'chat-container',
                
                // Initial message (if provided)
                initialMessage: document.getElementById('initialMessage').value || undefined,

                // Message Prompts (welcome + up to 3 prompts)
                messagePrompts: {
                    show: document.getElementById('promptsShow').checked,
                    welcome_message: document.getElementById('welcomeMessage').value,
                    prompts: [
                        document.getElementById('prompt1').value,
                        document.getElementById('prompt2').value,
                        document.getElementById('prompt3').value
                    ]
                },
                
                // Theme settings
                theme: {
                    buttonColor: document.getElementById('buttonColor').value,
                    headerTextColor: document.getElementById('headerTextColor').value,
                    backgroundColor: document.getElementById('backgroundColor').value,
                    textColor: document.getElementById('textColor').value,
                    buttonColor: document.getElementById('buttonColor').value,
                    buttonTextColor: document.getElementById('buttonTextColor').value,
                    // Toggle button styling
                    toggleBackgroundColor: document.getElementById('toggleBackgroundColor').value,
                    toggleTextColor: document.getElementById('toggleTextColor').value,
                    toggleIconColor: document.getElementById('toggleIconColor').value,
                },
                
                // Toggle text
                toggleText: document.getElementById('toggleText').value,
                
                // Message styling
                userBackgroundColor: document.getElementById('userBackgroundColor').value,
                userForegroundColor: document.getElementById('userForegroundColor').value,
                agentBackgroundColor: document.getElementById('agentBackgroundColor').value,
                agentForegroundColor: document.getElementById('agentForegroundColor').value,
                userIconColor: document.getElementById('userIconColor').value,
                agentIconColor: document.getElementById('agentIconColor').value,
                
                // Branding settings
                
                // Persistence settings
                persistence: {
                    enabled: document.getElementById('persistenceEnabled').checked,
                    days: parseInt(document.getElementById('persistenceDays').value, 10),
                    key: document.getElementById('persistenceKey').value || undefined
                },
                
                // Debug settings
                debug: document.getElementById('debugEnabled').checked ? {
                    enabled: true,
                    logLevel: document.getElementById('debugLogLevel').value,
                    timestamps: document.getElementById('debugTimestamps').checked,
                    console: true
                } : false,
                
                // Streaming configuration
                streaming: {
                    enabled: document.getElementById('streamingEnabled').checked
                },
                
                // AI Disclaimer configuration
                disclaimer: document.getElementById('disclaimerEnabled').checked ? {
                    enabled: true,
                    message: document.getElementById('disclaimerMessage').value,
                    linkText: document.getElementById('disclaimerLinkText').value || undefined,
                    linkUrl: document.getElementById('disclaimerLinkUrl').value || undefined
                } : {
                    enabled: false
                }
            };
        }
        
        function applyConfig() {
            console.log('Applying new configuration...');
            
            // Remove existing widget
            if (chatWidget) {
                console.log('Destroying existing widget instance');
                chatWidget.destroy();
                chatWidget = null;
            }
            
            // Small delay to ensure cleanup is complete
            setTimeout(() => {
                // Get new configuration
                const newConfig = getFormConfig();
                console.log('New configuration:', newConfig);
                
                // Update container styling based on variant
                const container = document.getElementById('chat-container');
                if (newConfig.variant === 'inline') {
                    container.classList.add('inline-mode');
                } else {
                    container.classList.remove('inline-mode');
                }
                
                // Initialize with new config
                const ChatWidget = window.AgentmanChatWidget?.ChatWidget || window.AgentmanChatWidget;
                if (!ChatWidget) {
                    console.error('ChatWidget class not found!');
                    return;
                }
                
                try {
                    chatWidget = new ChatWidget(newConfig);
                    console.log('Widget configuration applied successfully');
                } catch (error) {
                    console.error('Error creating new widget:', error);
                }
            }, 100);
        }
        
        function resetConfig() {
            // Reset form to defaults
            document.getElementById('apiUrl').value = 'http://localhost:8000';
            document.getElementById('agentToken').value = '.eJyrVipJzUvMK4nPTFGyMtJRSiwoyMlMTizJzM-DC6WnQuUNDQ1qAao_EHI.aI1tQA.hTJc3JYGdTzSBl-hL5xJPts9ysI';
            document.getElementById('title').value = 'Chat Assistant';
            document.getElementById('placeholder').value = 'Ask me anything...';
            document.getElementById('variant').value = 'corner';
            document.getElementById('position').value = 'bottom-right';
            document.getElementById('initiallyOpen').checked = false;
            document.getElementById('streamingEnabled').checked = true;
            
            // Theme settings
            document.getElementById('buttonColor').value = '#2563eb';
            document.getElementById('headerTextColor').value = '#FFFFFF';
            document.getElementById('backgroundColor').value = '#FFFFFF';
            document.getElementById('textColor').value = '#111827';
            document.getElementById('buttonColor').value = '#10b981';
            document.getElementById('buttonTextColor').value = '#FFFFFF';
            
            // Toggle button settings
            document.getElementById('toggleText').value = 'Ask Agentman';
            document.getElementById('toggleBackgroundColor').value = '#10b981';
            document.getElementById('toggleTextColor').value = '#FFFFFF';
            document.getElementById('toggleIconColor').value = '#000000';
            
            // Message styling
            document.getElementById('userBackgroundColor').value = '#10b981';
            document.getElementById('userForegroundColor').value = '#FFFFFF';
            document.getElementById('agentBackgroundColor').value = '#f3f4f6';
            document.getElementById('agentForegroundColor').value = '#111827';
            document.getElementById('userIconColor').value = '#10b981';
            document.getElementById('agentIconColor').value = '#1e293b';
            
            // Persistence settings
            document.getElementById('persistenceEnabled').checked = true;
            document.getElementById('persistenceDays').value = '7';
            document.getElementById('persistenceKey').value = '';
            
            // Disclaimer settings
            document.getElementById('disclaimerEnabled').checked = false;
            document.getElementById('disclaimerMessage').value = 'Responses are AI-generated and should be verified.';
            document.getElementById('disclaimerLinkText').value = 'Learn more';
            document.getElementById('disclaimerLinkUrl').value = 'https://example.com/ai-policy';
            
            // Branding settings
            
            // Update color previews
            updateColorPreviews();
            
            console.log('Form reset to defaults');
        }
        
        // Update all color preview elements
        function updateColorPreviews() {
            document.querySelectorAll('input[type="color"]').forEach(input => {
                const preview = input.nextElementSibling;
                if (preview && preview.classList.contains('color-preview')) {
                    preview.style.backgroundColor = input.value;
                }
            });
        }
        
        // Tab switching
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
        
        // Initialize color preview updates
        document.querySelectorAll('input[type="color"]').forEach(input => {
            input.addEventListener('input', function() {
                const preview = this.nextElementSibling;
                if (preview && preview.classList.contains('color-preview')) {
                    preview.style.backgroundColor = this.value;
                }
            });
        });
        
        // Listen for telemetry events from the chat widget
        window.addEventListener('chatwidget:telemetry', function(event) {
            // console.log('📊 Telemetry Event:', event.detail);
            
            // Show critical telemetry events in the console (only when debug is enabled)
            if (event.detail.eventName === 'metadata_without_messages') {
                console.warn('⚠️ Critical telemetry event detected:', event.detail);
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            updateColorPreviews();
            initWidget();
            showStorage();
        });
    </script>
</body>
</html>
